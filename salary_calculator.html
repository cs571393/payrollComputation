<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工资计算器</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');

        :root {
            --primary-color: #4a90e2; /* A softer, modern blue */
            --secondary-color: #6c757d;
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-background: rgba(255, 255, 255, 0.9);
            --text-color: #333;
            --subtle-text-color: #555;
            --border-color: #dce1e6;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-image: var(--background-gradient);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--card-background);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 700;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--subtle-text-color);
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #fdfdfd;
            transition: all 0.2s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        .inline-group {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #f7f9fc;
            padding: 10px;
            border-radius: 8px;
        }
        .inline-group label {
            margin-bottom: 0;
        }
        .inline-group p {
            margin: 0;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .button-group button {
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        #calc-button {
            background-color: var(--primary-color);
        }
        #clear-button {
            background-color: var(--secondary-color);
        }
        #results {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: #fdfdff;
            display: none;
        }
        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: var(--primary-color);
        }
        .final-salary {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--success-color);
            text-align: center;
            margin-bottom: 25px;
        }
        #result-details ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #result-details li {
            display: flex;
            justify-content: space-between;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
        }
        #result-details li:nth-child(even) {
            background-color: #f7f9fc;
        }
        #result-details li:last-child {
            border-bottom: none;
        }
        #result-details .value {
            font-weight: 500;
        }
        #result-details .income .value {
            color: var(--success-color);
        }
        #result-details .deduction .value {
            color: var(--danger-color);
        }

        .rules-container {
            margin-top: 30px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: #fdfdff;
        }
        .rules-toggle {
            width: 100%;
            background: none;
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--primary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rules-toggle::after {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }
        .rules-toggle.active::after {
            transform: rotate(180deg);
        }
        .rules-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0 20px;
        }
        .rules-details.active {
            max-height: 500px;
            padding: 0 20px 20px 20px;
        }
        .rules-details ul {
            list-style: none;
            padding: 0;
        }
        .rules-details li {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .rules-details code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #c7254e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>薪资计算器</h1>

        <div class="input-group inline-group">
            <label for="month-selector">计算月份:</label>
            <select id="month-selector"></select>
            <p><span id="working-days">...</span> 工作日</p>
        </div>

        <!-- Input fields -->
        <div class="input-group">
            <label for="position-salary">岗位工资 (元)</label>
            <input type="number" id="position-salary" placeholder="请输入岗位工资">
        </div>
        <div class="input-group">
            <label for="performance-bonus">绩效奖金 (元)</label>
            <input type="number" id="performance-bonus" placeholder="请输入绩效奖金">
        </div>
        <div class="input-group">
            <label for="meal-allowance-rate">每日餐补 (元)</label>
            <input type="number" id="meal-allowance-rate" value="12">
        </div>
        <div class="input-group">
            <label for="full-attendance-bonus-amount">全勤奖 (元)</label>
            <input type="number" id="full-attendance-bonus-amount" value="100">
        </div>
        <div class="input-group">
            <label for="other-allowances">其他津贴/补贴 (元)</label>
            <input type="number" id="other-allowances" value="0" placeholder="请输入其他津贴/补贴">
        </div>
        <div class="input-group">
            <label for="leave-hours">请假时长 (小时)</label>
            <input type="number" id="leave-hours" value="0" placeholder="请输入请假时长">
        </div>
        <div class="input-group">
            <label for="overtime-hours">加班时长 (小时)</label>
            <input type="number" id="overtime-hours" value="0" placeholder="请输入加班时长">
        </div>
        <div class="input-group">
            <label for="special-deduction">个税专项附加扣除 (元/月)</label>
            <input type="number" id="special-deduction" value="1000" placeholder="例如子女教育、住房贷款利息等">
        </div>
        <div class="input-group">
            <label for="other-deductions">其他合规扣款 (元)</label>
            <input type="number" id="other-deductions" value="0" placeholder="请输入其他扣款">
        </div>

        <div class="button-group">
            <button id="calc-button">计 算</button>
            <button id="clear-button">清除数据</button>
        </div>

        <div id="results">
            <p class="result-title">计算结果</p>
            <p class="final-salary" id="final-salary">¥ 0.00</p>
            <div id="result-details"></div>
        </div>

        <div class="rules-container">
            <button class="rules-toggle" id="rules-toggle">计算规则说明</button>
            <div class="rules-details" id="rules-details">
                <ul>
                    <li><strong>时薪:</strong> <code>岗位工资 / 当月工作日 / 8</code></li>
                    <li><strong>加班费:</strong> <code>时薪 * 加班时长</code></li>
                    <li><strong>请假扣款:</strong> <code>时薪 * 请假时长</code></li>
                    <li><strong>全勤奖:</strong> <code>当请假时长为 0 时，获得全额全勤奖</code></li>
                    <li><strong>餐补:</strong> <code>(工作日 - 请假小时 / 8) * 每日餐补</code></li>
                    <li><strong>应纳税所得额:</strong> <code>应发工资 - 5000 (起征点) - 社保 (¥470.09) - 专项附加扣除</code></li>
                    <li><strong>个人所得税:</strong> <code>根据应纳税所得额，按国家7级超额累进税率计算得出</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rulesToggle = document.getElementById('rules-toggle');
            const rulesDetails = document.getElementById('rules-details');
            const monthSelector = document.getElementById('month-selector');
            const workingDaysEl = document.getElementById('working-days');
            const calcButton = document.getElementById('calc-button');
            const clearButton = document.getElementById('clear-button');
            const resultsEl = document.getElementById('results');
            const finalSalaryEl = document.getElementById('final-salary');
            const resultDetailsEl = document.getElementById('result-details');

            const SOCIAL_SECURITY_DEDUCTION = 470.09;
            const TAX_THRESHOLD = 5000;
            const LOCAL_STORAGE_KEY = 'salaryCalculatorData';
            const holidayApiCache = {};

            const fieldsToPersist = [
                'position-salary', 'performance-bonus', 'meal-allowance-rate',
                'full-attendance-bonus-amount', 'other-allowances', 'leave-hours',
                'overtime-hours', 'special-deduction', 'other-deductions'
            ];
            const inputElements = fieldsToPersist.map(id => document.getElementById(id));

            function saveData() {
                const data = {};
                fieldsToPersist.forEach(id => { data[id] = document.getElementById(id).value; });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            }

            function loadData() {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    fieldsToPersist.forEach(id => {
                        if (data[id] !== undefined) { document.getElementById(id).value = data[id]; }
                    });
                }
            }

            function clearData() {
                if (confirm('确定要清除所有输入的数据吗？')) {
                    fieldsToPersist.forEach(id => {
                        const element = document.getElementById(id);
                        element.value = element.defaultValue || '';
                    });
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    resultsEl.style.display = 'none';
                }
            }
            
            rulesToggle.addEventListener('click', () => {
                rulesToggle.classList.toggle('active');
                rulesDetails.classList.toggle('active');
            });

            async function getHolidayData(year) {
                if (holidayApiCache[year]) return holidayApiCache[year];
                try {
                    const response = await fetch(`https://api.jiejiariapi.com/v1/holidays/${year}`);
                    if (!response.ok) throw new Error(`API request failed`);
                    const data = await response.json();
                    holidayApiCache[year] = data;
                    return data;
                } catch (error) {
                    console.error(`Failed to fetch holiday data for year ${year}:`, error);
                    holidayApiCache[year] = {};
                    return {};
                }
            }

            async function getWorkingDays(year, month) {
                const yearData = await getHolidayData(year);
                const daysInMonth = new Date(year, month, 0).getDate();
                let count = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(year, month - 1, day);
                    const dayOfWeek = d.getDay();
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const holidayInfo = yearData[dateStr];
                    let isWorkday = holidayInfo ? !holidayInfo.isOffDay : (dayOfWeek !== 0 && dayOfWeek !== 6);
                    if (isWorkday) count++;
                }
                return count;
            }

            async function populateMonths() {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                monthSelector.innerHTML = '';
                for (let y = currentYear - 2; y <= currentYear + 2; y++) {
                    for (let m = 1; m <= 12; m++) {
                        const option = document.createElement('option');
                        option.value = `${y}-${m}`;
                        option.textContent = `${y}年 ${m}月`;
                        if (y === currentYear && m === currentMonth) option.selected = true;
                        monthSelector.appendChild(option);
                    }
                }
                await updateWorkingDays();
            }

            async function updateWorkingDays() {
                const [year, month] = monthSelector.value.split('-').map(Number);
                workingDaysEl.textContent = '...';
                const days = await getWorkingDays(year, month);
                workingDaysEl.textContent = days;
            }
            
            function calculateTax(taxableIncome) {
                if (taxableIncome <= 0) return 0;
                const annualTaxableIncome = taxableIncome * 12;
                let tax = 0;
                if (annualTaxableIncome <= 36000) tax = annualTaxableIncome * 0.03;
                else if (annualTaxableIncome <= 144000) tax = annualTaxableIncome * 0.10 - 2520;
                else if (annualTaxableIncome <= 300000) tax = annualTaxableIncome * 0.20 - 16920;
                else if (annualTaxableIncome <= 420000) tax = annualTaxableIncome * 0.25 - 31920;
                else if (annualTaxableIncome <= 660000) tax = annualTaxableIncome * 0.30 - 52920;
                else if (annualTaxableIncome <= 960000) tax = annualTaxableIncome * 0.35 - 85920;
                else tax = annualTaxableIncome * 0.45 - 181920;
                return tax / 12;
            }

            function calculate() {
                const values = {};
                fieldsToPersist.forEach(id => { values[id] = parseFloat(document.getElementById(id).value) || 0; });
                if (values['position-salary'] === 0) { alert('请输入岗位工资！'); return; }
                const workingDays = parseInt(workingDaysEl.textContent, 10);
                if (isNaN(workingDays) || workingDays === 0) { alert("当月没有工作日或工作日正在加载，无法计算！"); return; }
                const hourlyRate = (values['position-salary'] / workingDays) / 8;
                const fullAttendanceBonus = values['leave-hours'] === 0 ? values['full-attendance-bonus-amount'] : 0;
                const equivalentLeaveDays = values['leave-hours'] / 8;
                const mealAllowance = Math.max(0, workingDays - equivalentLeaveDays) * values['meal-allowance-rate'];
                const overtimePay = values['overtime-hours'] * hourlyRate;
                const leaveDeductionAmount = values['leave-hours'] * hourlyRate;
                const grossIncome = (values['position-salary'] - leaveDeductionAmount) + values['performance-bonus'] + mealAllowance + fullAttendanceBonus + values['other-allowances'] + overtimePay;
                const incomeForTax = grossIncome - SOCIAL_SECURITY_DEDUCTION - values['special-deduction'] - TAX_THRESHOLD;
                const tax = calculateTax(incomeForTax);
                const finalSalary = grossIncome - SOCIAL_SECURITY_DEDUCTION - tax - values['other-deductions'];
                resultsEl.style.display = 'block';
                finalSalaryEl.textContent = `¥ ${finalSalary.toFixed(2)}`;
                resultDetailsEl.innerHTML = `<ul>
                        <li class="income"><span>(+) 岗位工资</span><span class="value">¥ ${values['position-salary'].toFixed(2)}</span></li>
                        <li class="income"><span>(+) 绩效奖金</span><span class="value">¥ ${values['performance-bonus'].toFixed(2)}</span></li>
                        <li class="income"><span>(+) 全勤奖</span><span class="value">¥ ${fullAttendanceBonus.toFixed(2)}</span></li>
                        <li class="income"><span>(+) 餐补</span><span class="value">¥ ${mealAllowance.toFixed(2)}</span></li>
                        <li class="income"><span>(+) 其他补贴</span><span class="value">¥ ${values['other-allowances'].toFixed(2)}</span></li>
                        <li class="income"><span>(+) 加班费</span><span class="value">¥ ${overtimePay.toFixed(2)}</span></li>
                        <li class="deduction"><span>(-) 请假扣款</span><span class="value">- ¥ ${leaveDeductionAmount.toFixed(2)}</span></li>
                        <li style="border-top: 1px solid var(--border-color); font-weight: bold;">
                            <span>应发工资</span><span class="value">¥ ${grossIncome.toFixed(2)}</span>
                        </li>
                        <li class="deduction"><span>(-) 社保个人部分</span><span class="value">- ¥ ${SOCIAL_SECURITY_DEDUCTION.toFixed(2)}</span></li>
                        <li class="deduction"><span>(-) 个人所得税</span><span class="value">- ¥ ${tax.toFixed(2)}</span></li>
                        <li class="deduction"><span>(-) 其他合规扣款</span><span class="value">- ¥ ${values['other-deductions'].toFixed(2)}</span></li>
                    </ul>`;
            }

            monthSelector.addEventListener('change', updateWorkingDays);
            calcButton.addEventListener('click', calculate);
            clearButton.addEventListener('click', clearData);
            inputElements.forEach(el => el.addEventListener('input', saveData));

            loadData();
            populateMonths();
        });
    </script>
</body>
</html>