<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥èµ„è®¡ç®—å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #6c757d;
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-background: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --subtle-text-color: #555;
            --border-color: #dce1e6;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
            background-image: var(--background-gradient);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--card-background);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 700;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--subtle-text-color);
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #fdfdfd;
            transition: all 0.2s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        .input-group input[readonly] {
            background-color: #f0f2f5;
            cursor: not-allowed;
        }
        .input-with-button {
            position: relative;
        }
        .input-with-button input {
            padding-right: 55px;
        }
        .calendar-btn {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            height: auto;
            width: 50px;
            border: none;
            background: #f0f2f5;
            padding: 0 12px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .calendar-btn:hover { background: #e4e8ec; }
        .inline-group {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #f7f9fc;
            padding: 10px;
            border-radius: 8px;
        }
        .inline-group label { margin-bottom: 0; }
        .inline-group p {
            margin: 0;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        .button-group { display: flex; gap: 15px; margin-top: 25px; }
        .button-group button {
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .button-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        #calc-button { background-color: var(--primary-color); }
        #clear-button { background-color: var(--secondary-color); }
        #results {
            margin-top: 30px; padding: 20px; border: 1px solid var(--border-color);
            border-radius: 12px; background-color: #fdfdff; display: none;
        }
        .result-title {
            font-size: 1.5rem; font-weight: 700; margin-bottom: 15px;
            text-align: center; color: var(--primary-color);
        }
        .final-salary {
            font-size: 2.5rem; font-weight: 700; color: var(--success-color);
            text-align: center; margin-bottom: 25px;
        }
        #result-details ul { list-style: none; padding: 0; margin: 0; }
        #result-details li {
            display: flex; justify-content: space-between; padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; flex-wrap: wrap;
        }
        #result-details li:nth-child(even) { background-color: #f7f9fc; }
        #result-details li:last-child { border-bottom: none; }
        #result-details .value { font-weight: 500; }
        #result-details .income .value { color: var(--success-color); }
        #result-details .deduction .value { color: var(--danger-color); }
        #result-details .info .value { color: var(--primary-color); }
        #result-details .sub-item { padding-left: 20px; font-size: 0.9em; color: #555; background-color: #f7f9fc !important; }
        #result-details .calculation-detail {
            display: block;
            width: 100%;
            text-align: right;
            color: #999;
            font-size: 0.8em;
            margin-top: -4px;
            padding-bottom: 8px;
        }

        .collapsible-toggle {
            background: none; border: none; color: var(--primary-color); cursor: pointer;
            padding: 10px 0; width: 100%; text-align: left; font-size: 1rem; font-weight: 500;
        }
        .collapsible-toggle::after { content: 'â–¼'; float: right; transition: transform 0.3s ease; }
        .collapsible-toggle.active::after { transform: rotate(180deg); }
        .collapsible-panel { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .collapsible-panel.active { max-height: 1000px; }

        .rules-container { margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .rules-details ul { list-style: none; padding:0; }
        .rules-details li { margin-bottom: 10px; font-size: 0.9rem; }
        .rules-details code { background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #c7254e; }
        .tax-table { overflow-x: auto; margin: 10px 0; }
        .tax-table table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .tax-table th, .tax-table td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        .tax-table th { background-color: #f2f2f2; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: visibility 0s 0.3s, opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active {
            opacity: 1; visibility: visible; transition: opacity 0.3s ease;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 420px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transform: scale(0.9); opacity: 0; transition: all 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1); opacity: 1;
        }
        .modal-content h3 { margin-top: 0; text-align: center; color: var(--primary-color); }
        #leave-records-list { list-style: none; padding: 0; margin-top: 15px; max-height: 140px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        #leave-records-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; }
        #leave-records-list li:last-child { border-bottom: none; }
        .delete-record { color: var(--danger-color); cursor: pointer; border: none; background: none; font-size: 1.2rem; font-weight: bold; }
        .modal-actions, .modal-adder { display: flex; gap: 10px; margin-top: 15px; }
        .modal-actions button, .modal-adder button { border-radius: 8px; border: none; font-size: 1rem; cursor: pointer; padding: 10px;}
        #add-leave-record-btn { background-color: var(--primary-color); color: white; }
        #modal-confirm-btn { background-color: var(--success-color); color: white; width: 100%; }
        #modal-cancel-btn { background-color: var(--secondary-color); color: white; width: 100%; }
        #leave-records-total { margin-top: 15px; text-align: right; font-weight: bold; font-size: 1.1rem; }
        .leave-dates-display {
            font-size: 0.85em;
            color: var(--secondary-color);
            margin-top: 6px;
            padding-left: 5px;
            display: flex; /* Make it a flex container */
            align-items: center; /* Vertically align items in the center */
            flex-wrap: wrap; /* Allow content to wrap if too long */
        }
        .leave-text-content {
            /* Removed line-height to allow natural flow */
        }
        .clear-leave-btn {
            border: none;
            background: #e0e0e0;
            color: #555;
            border-radius: 4px; /* Square button with slight rounding */
            width: 16px; /* Smaller square button */
            height: 16px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 10px; /* Smaller font for 'x' */
            display: flex; /* Use flexbox for centering content */
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è–ªèµ„è®¡ç®—å™¨</h1>
        
        <div class="input-group inline-group">
            <label for="month-selector">è®¡ç®—æœˆä»½:</label>
            <select id="month-selector"></select>
            <p><span id="working-days">...</span> å·¥ä½œæ—¥</p>
            <!-- New manual input for working days -->
            <div id="manual-working-days-group" style="display: none; margin-left: 10px;">
                <label for="manual-working-days-input" style="margin-right: 5px;">æ‰‹åŠ¨è¾“å…¥:</label>
                <input type="number" id="manual-working-days-input" value="" style="width: 60px;">
            </div>
        </div>

        <div class="input-group">
            <label for="position-salary">å²—ä½å·¥èµ„ (å…ƒ)</label>
            <input type="number" id="position-salary" placeholder="è¯·è¾“å…¥å²—ä½å·¥èµ„">
        </div>
        <div class="input-group">
            <label for="performance-bonus">ç»©æ•ˆå¥–é‡‘ (å…ƒ)</label>
            <input type="number" id="performance-bonus" placeholder="è¯·è¾“å…¥ç»©æ•ˆå¥–é‡‘">
        </div>
        <div class="input-group">
            <label for="meal-allowance-rate">æ¯æ—¥é¤è¡¥ (å…ƒ)</label>
            <input type="number" id="meal-allowance-rate" value="12">
        </div>
        <div class="input-group">
            <label for="full-attendance-bonus-amount">å…¨å‹¤å¥– (å…ƒ)</label>
            <input type="number" id="full-attendance-bonus-amount" value="100">
        </div>
        <div class="input-group">
            <label for="annual-leave-hours">å¹´å‡æ—¶é•¿ (å°æ—¶) (æ—¥å†é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥)</label>
            <div class="input-with-button">
                <input type="number" id="annual-leave-hours" value="0" placeholder="å¸¦è–ªå‡,ä¸å½±å“å…¨å‹¤">
                <button class="calendar-btn" data-target-id="annual-leave-hours" title="é€šè¿‡æ—¥å†é€‰æ‹©">ğŸ“…</button>
            </div>
            <div class="leave-dates-display" id="annual-leave-hours-display"></div>
        </div>
        <div class="input-group">
            <label for="personal-leave-hours">äº‹/ç—…å‡æ—¶é•¿ (å°æ—¶) (æ—¥å†é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥)</label>
            <div class="input-with-button">
                <input type="number" id="personal-leave-hours" value="0" placeholder="å½±å“å…¨å‹¤å’Œå·¥èµ„">
                <button class="calendar-btn" data-target-id="personal-leave-hours" title="é€šè¿‡æ—¥å†é€‰æ‹©">ğŸ“…</button>
            </div>
            <div class="leave-dates-display" id="personal-leave-hours-display"></div>
        </div>
        <div class="input-group">
            <label for="overtime-hours">åŠ ç­æ—¶é•¿ (å°æ—¶)</label>
            <input type="number" id="overtime-hours" value="0">
        </div>
        <div class="input-group">
            <label for="social-security-deduction">ç¤¾ä¿ä¸ªäººéƒ¨åˆ† (å…ƒ)</label>
            <input type="number" id="social-security-deduction" value="470.09">
        </div>
        <div class="input-group">
            <label for="special-deduction">ä¸ªç¨ä¸“é¡¹é™„åŠ æ‰£é™¤ (å…ƒ/æœˆ)</label>
            <input type="number" id="special-deduction" value="1000">
        </div>
        
        <button class="collapsible-toggle" id="more-options-toggle">æ›´å¤šé€‰é¡¹</button>
        <div class="collapsible-panel" id="more-options-panel">
            <div class="input-group">
                <label for="other-allowances">å…¶ä»–æ´¥è´´/è¡¥è´´ (å…ƒ)</label>
                <input type="number" id="other-allowances" value="0">
            </div>
            <div class="input-group">
                <label for="other-deductions">å…¶ä»–åˆè§„æ‰£æ¬¾ (å…ƒ)</label>
                <input type="number" id="other-deductions" value="0">
            </div>
        </div>

        <div class="button-group">
            <button id="calc-button">è®¡ ç®—</button>
            <button id="clear-button">æ¸…é™¤æ•°æ®</button>
        </div>

        <div id="results"></div>
        <div class="rules-container">
            <button class="collapsible-toggle" id="rules-toggle">è®¡ç®—è§„åˆ™è¯´æ˜</button>
            <div class="collapsible-panel" id="rules-panel">
                 <ul>
                    <li><strong>æ—¶è–ª:</strong> <code>å²—ä½å·¥èµ„ / å½“æœˆå·¥ä½œæ—¥ / 8</code></li>
                    <li><strong>åŠ ç­è´¹:</strong> <code>æ—¶è–ª * åŠ ç­æ—¶é•¿</code></li>
                    <li><strong>äº‹/ç—…å‡æ‰£æ¬¾:</strong> <code>æ—¶è–ª * äº‹/ç—…å‡æ—¶é•¿</code> (å¹´å‡ä¸æ‰£æ¬¾)</li>
                    <li><strong>å…¨å‹¤å¥–:</strong> <code>å½“äº‹/ç—…å‡æ—¶é•¿ä¸º 0 æ—¶è·å¾—</code> (å¹´å‡ä¸å½±å“)</li>
                    <li><strong>é¤è¡¥:</strong> <code>(å·¥ä½œæ—¥ - æ€»è¯·å‡å¤©æ•°) * æ¯æ—¥é¤è¡¥</code> (æ€»è¯·å‡å¤©æ•° = å‘ä¸Šå–æ•´( (å¹´å‡+äº‹ç—…å‡)/8 ) )</li>
                    <li id="tax-rule-details"></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="leave-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="leave-modal-title">æ·»åŠ è¯·å‡è®°å½•</h3>
            <div class="modal-adder">
                <input type="text" id="leave-date-picker" placeholder="é€‰æ‹©æ—¥æœŸ...">
                <input type="number" id="leave-hours-picker" value="8" style="width: 80px;">
                <button id="add-leave-record-btn">æ·»åŠ </button>
            </div>
            <ul id="leave-records-list"></ul>
            <p id="leave-records-total">æ€»è®¡: 0 å°æ—¶</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn">ç¡®è®¤æ·»åŠ </button>
                <button id="modal-cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/zh.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const monthSelector = document.getElementById('month-selector');
            const workingDaysEl = document.getElementById('working-days');
            const calcButton = document.getElementById('calc-button');
            const clearButton = document.getElementById('clear-button');
            const resultsEl = document.getElementById('results');
            
            setupCollapsible(document.getElementById('rules-toggle'), document.getElementById('rules-panel'));
            setupCollapsible(document.getElementById('more-options-toggle'), document.getElementById('more-options-panel'));

            const leaveModal = document.getElementById('leave-modal');
            const leaveModalTitle = document.getElementById('leave-modal-title');
            const leaveDatePicker = document.getElementById('leave-date-picker');
            const leaveHoursPicker = document.getElementById('leave-hours-picker');
            const addLeaveRecordBtn = document.getElementById('add-leave-record-btn');
            const leaveRecordsList = document.getElementById('leave-records-list');
            const leaveRecordsTotal = document.getElementById('leave-records-total');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            let leaveRecords = [];
            let currentLeaveTargetInput = null;
            let fp;
            try {
                fp = flatpickr(leaveDatePicker, { locale: "zh", altInput: true, altFormat: "Y-m-d", dateFormat: "Y-m-d" });
            } catch (e) {
                console.error("flatpickr initialization failed!", e);
                document.querySelectorAll('.calendar-btn').forEach(btn => btn.style.display = 'none');
            }

            const SOCIAL_SECURITY_DEDUCTION = 470.09;
            const TAX_THRESHOLD = 5000;
            const LOCAL_STORAGE_KEY = 'salaryCalculatorData';
            const holidayApiCache = {};
            const fieldsToPersist = [
                'position-salary', 'performance-bonus', 'meal-allowance-rate',
                'full-attendance-bonus-amount', 'other-allowances', 'annual-leave-hours', 
                'personal-leave-hours', 'overtime-hours', 'social-security-deduction', 'special-deduction', 'other-deductions'
            ];

            function calculate() {
                const values = {};
                fieldsToPersist.forEach(id => { values[id] = parseFloat(document.getElementById(id).value) || 0; });
                if (values['position-salary'] === 0) { alert('è¯·è¾“å…¥å²—ä½å·¥èµ„ï¼'); return; }
                
                const manualWorkingDaysInput = document.getElementById('manual-working-days-input');
                let workingDays;
                if (manualWorkingDaysInput && manualWorkingDaysInput.style.display !== 'none' && parseFloat(manualWorkingDaysInput.value) > 0) {
                    workingDays = parseFloat(manualWorkingDaysInput.value);
                } else {
                    workingDays = parseInt(workingDaysEl.textContent, 10);
                }

                if (isNaN(workingDays) || workingDays <= 0) { alert("å½“æœˆå·¥ä½œæ—¥æ— æ•ˆï¼Œæ— æ³•è®¡ç®—ï¼è¯·æ£€æŸ¥è‡ªåŠ¨è·å–æˆ–æ‰‹åŠ¨è¾“å…¥ã€‚"); return; }
                
                const hourlyRate = (values['position-salary'] / workingDays) / 8;

                const annualLeaveInput = document.getElementById('annual-leave-hours');
                const personalLeaveInput = document.getElementById('personal-leave-hours');

                const allCalendarDates = new Set();
                let manualTotalHours = 0;

                const annualRecordsStr = annualLeaveInput.dataset.leaveRecords;
                if (annualRecordsStr && annualRecordsStr !== '[]') {
                    try {
                        const annualRecords = JSON.parse(annualRecordsStr);
                        annualRecords.forEach(r => allCalendarDates.add(r.date));
                    } catch(e) { console.error("Error parsing annual leave records", e); }
                } else {
                    manualTotalHours += values['annual-leave-hours'];
                }

                const personalRecordsStr = personalLeaveInput.dataset.leaveRecords;
                if (personalRecordsStr && personalRecordsStr !== '[]') {
                     try {
                        const personalRecords = JSON.parse(personalRecordsStr);
                        personalRecords.forEach(r => allCalendarDates.add(r.date));
                    } catch(e) { console.error("Error parsing personal leave records", e); }
                } else {
                    manualTotalHours += values['personal-leave-hours'];
                }

                const manualLeaveDays = Math.ceil(manualTotalHours / 8);
                const daysWithLeave = allCalendarDates.size + manualLeaveDays;
                
                const fullAttendanceBonus = values['personal-leave-hours'] === 0 ? values['full-attendance-bonus-amount'] : 0;
                const mealAllowance = Math.max(0, workingDays - daysWithLeave) * values['meal-allowance-rate'];
                const overtimePay = values['overtime-hours'] * hourlyRate;
                const leaveDeductionAmount = values['personal-leave-hours'] * hourlyRate;
                
                const grossIncome = (values['position-salary'] - leaveDeductionAmount) + values['performance-bonus'] + mealAllowance + fullAttendanceBonus + values['other-allowances'] + overtimePay;
                const incomeForTax = grossIncome - values['social-security-deduction'] - values['special-deduction'] - TAX_THRESHOLD;
                const taxDetails = calculateTax(incomeForTax);
                
                const finalSalary = grossIncome - values['social-security-deduction'] - taxDetails.monthlyTax - values['other-deductions'];
                
                resultsEl.style.display = 'block';
                resultsEl.innerHTML = `
                    <p class="result-title">è®¡ç®—ç»“æœ</p>
                    <p class="final-salary">Â¥ ${finalSalary.toFixed(2)}</p>
                    <div id="result-details">
                        <ul>
                            <li class="info">
                                <span>æ—¶è–ª</span>
                                <span class="value">Â¥ ${hourlyRate.toFixed(2)}</span>
                                <small class="calculation-detail">(${values['position-salary']} / ${workingDays} / 8)</small>
                            </li>
                            <li class="income">
                                <span>(+) å²—ä½å·¥èµ„</span>
                                <span class="value">Â¥ ${values['position-salary'].toFixed(2)}</span>
                            </li>
                            <li class="income">
                                <span>(+) ç»©æ•ˆå¥–é‡‘</span>
                                <span class="value">Â¥ ${values['performance-bonus'].toFixed(2)}</span>
                            </li>
                            <li class="income">
                                <span>(+) å…¨å‹¤å¥–</span>
                                <span class="value">Â¥ ${fullAttendanceBonus.toFixed(2)}</span>
                                ${fullAttendanceBonus > 0 ? '<small class="calculation-detail">(æ— äº‹/ç—…å‡)</small>' : ''}
                            </li>
                            <li class="income">
                                <span>(+) é¤è¡¥</span>
                                <span class="value">Â¥ ${mealAllowance.toFixed(2)}</span>
                                <small class="calculation-detail">((${workingDays} - ${daysWithLeave})å¤© * ${values['meal-allowance-rate']}å…ƒ/å¤©)</small>
                            </li>
                            <li class="income">
                                <span>(+) å…¶ä»–è¡¥è´´</span>
                                <span class="value">Â¥ ${values['other-allowances'].toFixed(2)}</span>
                            </li>
                            <li class="income">
                                <span>(+) åŠ ç­è´¹</span>
                                <span class="value">Â¥ ${overtimePay.toFixed(2)}</span>
                                <small class="calculation-detail">(${hourlyRate.toFixed(2)}å…ƒ/æ—¶ * ${values['overtime-hours']}å°æ—¶)</small>
                            </li>
                            <li class="deduction">
                                <span>(-) äº‹/ç—…å‡æ‰£æ¬¾</span>
                                <span class="value">- Â¥ ${leaveDeductionAmount.toFixed(2)}</span>
                                <small class="calculation-detail">(${hourlyRate.toFixed(2)}å…ƒ/æ—¶ * ${values['personal-leave-hours']}å°æ—¶)</small>
                            </li>
                            <li style="border-top: 1px solid var(--border-color); font-weight: bold;">
                                <span>åº”å‘å·¥èµ„</span>
                                <span class="value">Â¥ ${grossIncome.toFixed(2)}</span>
                            </li>
                            <li class="deduction">
                                <span>(-) ç¤¾ä¿ä¸ªäººéƒ¨åˆ†</span>
                                <span class="value">- Â¥ ${values['social-security-deduction'].toFixed(2)}</span>
                            </li>
                            <li class="sub-item">
                                <span>&nbsp;&nbsp;&nbsp;&nbsp;åº”çº³ç¨æ‰€å¾—é¢</span>
                                <span class="value">Â¥ ${Math.max(0, incomeForTax).toFixed(2)}</span>
                                <small class="calculation-detail">(${grossIncome.toFixed(2)} - ${values['social-security-deduction']} - ${values['special-deduction']} - ${TAX_THRESHOLD})</small>
                            </li>
                            <li class="deduction" style="font-weight: bold;">
                                <span>(-) æœ¬æœˆé¢„ç¼´ä¸ªç¨</span>
                                <span class="value">- Â¥ ${taxDetails.monthlyTax.toFixed(2)}</span>
                            </li>
                            ${taxDetails.taxBreakdown.map(b => `
                                <li class="sub-item deduction">
                                    <span>&nbsp;&nbsp;&nbsp;&nbsp; ${b.range} éƒ¨åˆ† (${b.amount.toFixed(2)} å…ƒ @ ${b.rate}%)</span>
                                    <span class="value">- Â¥ ${b.tax.toFixed(2)}</span>
                                </li>
                            `).join('')}
                            <li class="deduction">
                                <span>(-) å…¶ä»–åˆè§„æ‰£æ¬¾</span>
                                <span class="value">- Â¥ ${values['other-deductions'].toFixed(2)}</span>
                            </li>
                        </ul>
                    </div>`;
            }

            function calculateTax(monthlyTaxableIncome) {
                if (monthlyTaxableIncome <= 0) return { monthlyTax: 0, rate: 0, quickDeduction: 0, taxBreakdown: [] };
                
                let monthlyTax = 0;
                let rate = 0; 
                let quickDeduction = 0;
                let breakdown = []; // Array to store breakdown details
                
                // Define tax brackets with their lower bound, upper bound, and rate
                const brackets = [
                    { lower: 0, upper: 3000, rate: 0.03, qd: 0 },
                    { lower: 3001, upper: 12000, rate: 0.10, qd: 210 },
                    { lower: 12001, upper: 25000, rate: 0.20, qd: 1410 },
                    { lower: 25001, upper: 35000, rate: 0.25, qd: 2660 },
                    { lower: 35001, upper: 55000, rate: 0.30, qd: 4410 },
                    { lower: 55001, upper: 80000, rate: 0.35, qd: 7160 },
                    { lower: 80001, upper: Infinity, rate: 0.45, qd: 15160 }
                ];

                let remainingTaxable = monthlyTaxableIncome;

                for (const bracket of brackets) {
                    if (remainingTaxable <= 0) break; // No more taxable income
                    
                    const currentBracketLower = bracket.lower === 0 ? 0 : bracket.lower - 1; // Adjust lower bound for range calc
                    const currentBracketUpper = bracket.upper;

                    const taxableInThisBracket = Math.min(remainingTaxable, currentBracketUpper - currentBracketLower);
                    
                    if (taxableInThisBracket > 0) {
                        const taxForSegment = taxableInThisBracket * bracket.rate;
                        monthlyTax += taxForSegment;
                        breakdown.push({
                            range: `${bracket.lower}-${bracket.upper === Infinity ? 'ä»¥ä¸Š' : bracket.upper}å…ƒ`,
                            rate: bracket.rate * 100,
                            amount: taxableInThisBracket,
                            tax: taxForSegment
                        });
                        rate = bracket.rate * 100; // Keep track of the highest rate for display
                        quickDeduction = bracket.qd; // Keep track of quick deduction for display
                        remainingTaxable -= taxableInThisBracket;
                    }
                }
                
                return { monthlyTax: monthlyTax, rate, quickDeduction: quickDeduction, taxBreakdown: breakdown };
            }

            function saveData() {
                const data = {};
                fieldsToPersist.forEach(id => { data[id] = document.getElementById(id).value; });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            }
            function loadData() {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    fieldsToPersist.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && data[id] !== undefined) { el.value = data[id]; }
                    });
                }
            }
            function clearData() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¾“å…¥çš„æ•°æ®å—ï¼Ÿ')) {
                    fieldsToPersist.forEach(id => {
                        const element = document.getElementById(id);
                        element.value = element.defaultValue || '';
                         if (id.includes('leave-hours')) {
                            element.readOnly = false;
                            element.dataset.leaveRecords = '';
                            const displayEl = document.getElementById(id + '-display');
                            if (displayEl) displayEl.innerHTML = '';
                        }
                    });
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    resultsEl.style.display = 'none';
                    document.getElementById('meal-allowance-rate').value = 12;
                    document.getElementById('full-attendance-bonus-amount').value = 100;
                    document.getElementById('special-deduction').value = 1000;
                    document.getElementById('annual-leave-hours').value = 0;
                    document.getElementById('personal-leave-hours').value = 0;
                    document.getElementById('overtime-hours').value = 0;
                    document.getElementById('other-allowances').value = 0;
                    document.getElementById('other-deductions').value = 0;
                }
            }
            
            function setupCollapsible(toggleEl, panelEl) {
                if (!toggleEl || !panelEl) return;
                toggleEl.addEventListener('click', () => {
                    toggleEl.classList.toggle('active');
                    panelEl.classList.toggle('active');
                });
            }

            function openLeaveModal(targetInput) {
                if (!targetInput) return;
                currentLeaveTargetInput = targetInput;
                const label = document.querySelector(`label[for=${targetInput.id}]`);
                leaveModalTitle.textContent = `æ·»åŠ  ${label ? label.textContent.split('(')[0].trim() : 'è¯·å‡è®°å½•'}`;
                
                // Load existing leave records if available
                const existingRecordsStr = currentLeaveTargetInput.dataset.leaveRecords;
                if (existingRecordsStr && existingRecordsStr !== '[]') {
                    try {
                        leaveRecords = JSON.parse(existingRecordsStr);
                    } catch(e) {
                        console.error("Error parsing existing leave records", e);
                        leaveRecords = []; // Fallback to empty if parsing fails
                    }
                                } else {
                                    leaveRecords = [];
                                }
                                
                                // Set default date for flatpickr
                                let defaultDate = new Date(); // Default to today
                                if (leaveRecords.length > 0) {
                                    // If there are existing records, default to the first one's date
                                    defaultDate = leaveRecords[0].date; 
                                }
                                if (fp) { // Ensure flatpickr is initialized
                                    fp.setDate(defaultDate, true); 
                                }
                
                                renderLeaveRecords();
                                leaveModal.classList.add('active');
            }
            function closeLeaveModal() {
                const displayEl = document.getElementById(currentLeaveTargetInput.id + '-display');
                if (currentLeaveTargetInput && (!displayEl || !displayEl.innerHTML)) {
                   currentLeaveTargetInput.readOnly = false;
                }
                leaveModal.classList.remove('active');
                if (fp) fp.clear();
            }
            function addLeaveRecord() {
                const selectedDate = fp.selectedDates[0];
                if (!selectedDate) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸ"); return; }
                const hours = parseFloat(leaveHoursPicker.value) || 0;
                if (hours <= 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å°æ—¶æ•°"); return; }
                leaveRecords.push({ id: Date.now(), date: flatpickr.formatDate(selectedDate, "Y-m-d"), hours });
                leaveRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
                renderLeaveRecords();
                fp.clear();
                leaveDatePicker.focus();
            }
            function deleteLeaveRecord(recordId) {
                leaveRecords = leaveRecords.filter(r => r.id !== recordId);
                renderLeaveRecords();
            }
            function renderLeaveRecords() {
                leaveRecordsList.innerHTML = '';
                let total = 0;
                leaveRecords.forEach(record => {
                    const li = document.createElement('li');
                    li.textContent = `${record.date}: ${record.hours} å°æ—¶`;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.className = 'delete-record';
                    deleteBtn.title = 'åˆ é™¤æ­¤æ¡è®°å½•';
                    deleteBtn.onclick = () => deleteLeaveRecord(record.id);
                    li.appendChild(deleteBtn);
                    leaveRecordsList.appendChild(li);
                    total += record.hours;
                });
                leaveRecordsTotal.textContent = `æ€»è®¡: ${total} å°æ—¶`;
            }
            function confirmLeave() {
                const totalHours = leaveRecords.reduce((sum, rec) => sum + rec.hours, 0);
                if (currentLeaveTargetInput) {
                    currentLeaveTargetInput.value = totalHours;
                    currentLeaveTargetInput.readOnly = true;
                    currentLeaveTargetInput.dataset.leaveRecords = JSON.stringify(leaveRecords);
                    
                    const displayId = currentLeaveTargetInput.id + '-display';
                    const displayEl = document.getElementById(displayId);
                    if (displayEl) {
                        const dateStrings = leaveRecords.map(r => r.date.split('-').slice(1).join('/'));
                        const uniqueDays = new Set(leaveRecords.map(r => r.date)).size;
                        displayEl.innerHTML = `<span class="leave-text-content">å·²é€‰ ${uniqueDays} å¤© (${dateStrings.join(', ')})</span> <button type="button" class="clear-leave-btn" data-target-id="${currentLeaveTargetInput.id}" title="æ¸…é™¤æ—¥å†é€‰æ‹©">Ã—</button>`;
                    }
                    saveData();
                }
                closeLeaveModal();
            }

            async function getHolidayData(year) {
                if (holidayApiCache[year]) return holidayApiCache[year];
                try {
                    const response = await fetch(`https://api.jiejiariapi.com/v1/holidays/${year}`);
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    holidayApiCache[year] = await response.json();
                } catch (error) {
                    console.error(`Failed to fetch holiday data for year ${year}:`, error);
                    delete holidayApiCache[year]; // Clear cache for failed year
                    throw error; // Re-throw the error
                }
                return holidayApiCache[year];
            }
            async function getWorkingDays(year, month) {
                const yearData = await getHolidayData(year);
                let count = 0;
                const daysInMonth = new Date(year, month, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(year, month - 1, day);
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const holidayInfo = yearData[dateStr];
                    if (holidayInfo ? !holidayInfo.isOffDay : (d.getDay() !== 0 && d.getDay() !== 6)) count++;
                }
                return count;
            }
            async function populateMonths() {
                const now = new Date();
                monthSelector.innerHTML = '';
                for (let y = now.getFullYear() - 2; y <= now.getFullYear() + 2; y++) {
                    for (let m = 1; m <= 12; m++) {
                        const option = document.createElement('option');
                        option.value = `${y}-${m}`;
                        option.textContent = `${y}å¹´ ${m}æœˆ`;
                        if (y === now.getFullYear() && m === now.getMonth() + 1) option.selected = true;
                        monthSelector.appendChild(option);
                    }
                }
                await updateWorkingDays();
            }
            async function updateWorkingDays() {
                const [year, month] = monthSelector.value.split('-').map(Number);
                workingDaysEl.textContent = '...';
                const manualWorkingDaysGroup = document.getElementById('manual-working-days-group');
                const manualWorkingDaysInput = document.getElementById('manual-working-days-input');

                try {
                    const fetchedWorkingDays = await getWorkingDays(year, month);
                    workingDaysEl.textContent = fetchedWorkingDays;
                    manualWorkingDaysGroup.style.display = 'none'; // Hide manual input if successful
                    manualWorkingDaysInput.value = ''; // Clear manual input
                } catch (error) {
                    console.error("Failed to fetch working days automatically, enabling manual input.", error);
                    workingDaysEl.textContent = 'æ— æ³•è·å–'; // Indicate failure
                    manualWorkingDaysGroup.style.display = 'flex'; // Show manual input
                    manualWorkingDaysInput.value = '21'; // Default placeholder
                }
            }
            
            function renderTaxRuleDetails() {
                 const taxRuleEl = document.getElementById('tax-rule-details');
                if (!taxRuleEl) return;
                taxRuleEl.innerHTML = `<strong>ä¸ªäººæ‰€å¾—ç¨:</strong>
                    <p style="margin: 5px 0; font-size: 0.9em;">1. å…ˆè®¡ç®—åº”çº³ç¨æ‰€å¾—é¢: <br><code>åº”å‘å·¥èµ„ - 5000èµ·å¾ç‚¹ - ç¤¾ä¿ - ä¸“é¡¹é™„åŠ æ‰£é™¤</code></p>
                    <p style="margin: 5px 0; font-size: 0.9em;">2. æ ¹æ®æœˆåº¦åº”çº³ç¨æ‰€å¾—é¢ï¼Œå¯¹ç…§ä¸‹è¡¨ç¡®å®šç¨ç‡å’Œé€Ÿç®—æ‰£é™¤æ•°ã€‚</p>
                    <div class="tax-table">
                        <table>
                            <thead><tr><th>çº§åˆ«</th><th>æœˆåº¦åº”çº³ç¨æ‰€å¾—é¢</th><th>ç¨ç‡(%)</th><th>é€Ÿç®—æ‰£é™¤æ•°</th></tr></thead>
                            <tbody>
                                <tr><td>1</td><td>ä¸è¶…è¿‡3,000å…ƒ</td><td>3</td><td>0</td></tr>
                                <tr><td>2</td><td>3,001å…ƒ è‡³ 12,000å…ƒ</td><td>10</td><td>210</td></tr>
                                <tr><td>3</td><td>12,001å…ƒ è‡³ 25,000å…ƒ</td><td>20</td><td>1,410</td></tr>
                                <tr><td>4</td><td>25,001å…ƒ è‡³ 35,000å…ƒ</td><td>25</td><td>2,660</td></tr>
                                <tr><td>5</td><td>35,001å…ƒ è‡³ 55,000å…ƒ</td><td>30</td><td>4,410</td></tr>
                                <tr><td>6</td><td>55,001å…ƒ è‡³ 80,000å…ƒ</td><td>35</td><td>7,160</td></tr>
                                <tr><td>7</td><td>è¶…è¿‡80,000å…ƒ</td><td>45</td><td>15,160</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p style="font-size:0.8em; color:#888;">(æ³¨: æœ¬å·¥å…·é‡‡ç”¨æŒ‰æœˆè®¡ç¨æ³•ï¼Œä¸è´¢åŠ¡å®é™…çš„â€œç´¯è®¡é¢„æ‰£æ³•â€åœ¨ç´¯è®¡åº”çº³ç¨æ‰€å¾—é¢æ–¹é¢çš„å¤„ç†ç›¸åŒã€‚)</p>
                `;
            }

            document.querySelectorAll('.calendar-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.targetId;
                    const targetInput = document.getElementById(targetId);
                    openLeaveModal(targetInput);
                });
            });
            
            addLeaveRecordBtn.addEventListener('click', addLeaveRecord);
            modalConfirmBtn.addEventListener('click', confirmLeave);
            modalCancelBtn.addEventListener('click', closeLeaveModal);
            monthSelector.addEventListener('change', updateWorkingDays);
            calcButton.addEventListener('click', calculate);
            clearButton.addEventListener('click', clearData);
            fieldsToPersist.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', saveData);
            });
            
            ['annual-leave-hours', 'personal-leave-hours'].forEach(id => {
                const inputEl = document.getElementById(id);
                if (inputEl) {
                    inputEl.addEventListener('input', () => {
                        if (document.activeElement === inputEl) { 
                            inputEl.readOnly = false;
                            inputEl.dataset.leaveRecords = '';
                            const displayEl = document.getElementById(id + '-display');
                            if (displayEl) {
                                displayEl.innerHTML = '';
                            }
                        }
                    });
                }
            });

            document.querySelector('.container').addEventListener('click', function(e) {
                if (e.target.classList.contains('clear-leave-btn')) {
                    e.preventDefault();
                    const targetId = e.target.dataset.targetId;
                    const inputEl = document.getElementById(targetId);
                    const displayEl = document.getElementById(targetId + '-display');
                    
                    if (inputEl) {
                        inputEl.value = 0;
                        inputEl.readOnly = false;
                        inputEl.dataset.leaveRecords = '';
                    }
                    if (displayEl) {
                        displayEl.innerHTML = '';
                    }
                    saveData();
                }
            });

            renderTaxRuleDetails();
            loadData();
            populateMonths();
        });
    </script>
</body>
</html>